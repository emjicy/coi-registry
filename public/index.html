<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>COI Registry</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; margin: 2rem; }
    h1 { margin: 0 0 .25rem 0 }
    .sub { color: #666; margin: 0 0 .75rem 0 }
    .meta { color:#666; font-size:.9rem; margin: 0 0 1.25rem 0 }
    table { width: 100% }
    a { text-decoration: none }
    a:hover { text-decoration: underline }
    .card { display:grid; gap:.75rem; max-width: 720px; padding:1rem; border:1px solid #ddd; border-radius:.75rem; margin:1.5rem 0; }
    .row { display:grid; gap:.5rem; }
    input, select { width:100%; padding:.5rem; }
    hr { margin:2rem 0 }
  </style>
</head>
<body>
  <h1>Conflict of Interest Registry</h1>
  <p class="sub">Transparent, auditable disclosures for DAO governance.</p>
  <p class="meta" id="meta"></p>

  <table id="registry" class="display compact"></table>

  <p style="margin-top:1rem">
    <a href="registry.json" download>Download JSON</a> ·
    <a href="https://github.com/emjicy/coi-registry">Contribute on GitHub</a>
  </p>

  <hr />

  <h2>Submit a Disclosure</h2>
  <p class="sub">This form pre-fills a GitHub Issue in <a href="https://github.com/emjicy/coi-registry" target="_blank" rel="noopener">emjicy/coi-registry</a>. You’ll review & submit there.</p>

  <form id="disclosure-form" onsubmit="return false;" class="row">
    <label>Delegate ID / ENS <span style="color:#c00">*</span>
      <input id="f-id" type="text" required placeholder="e.g., mel.eth" />
    </label>
    <label>Display Name
      <input id="f-name" type="text" placeholder="e.g., mel.eth (StableLab)" />
    </label>
    <label>Organization
      <input id="f-org" type="text" placeholder="e.g., StableLab" />
    </label>
    <label>Wallet(s) (comma-separated)
      <input id="f-wallets" type="text" placeholder="0x..., 0x..." />
    </label>

    <div class="card">
      <strong>Interest Details</strong>
      <label>Type <span style="color:#c00">*</span>
        <select id="f-type" required>
          <option value="">-- select --</option>
          <option value="direct">direct</option>
          <option value="indirect">indirect</option>
        </select>
      </label>
      <label>Project <span style="color:#c00">*</span>
        <input id="f-project" type="text" required placeholder="e.g., Protocol X" />
      </label>
      <label>Role
        <input id="f-role" type="text" placeholder="advisor / investor / service_provider" />
      </label>
      <label>Interest Type
        <input id="f-itype" type="text" placeholder="tokens / equity / retainer / grants" />
      </label>
      <label>Materiality
        <input id="f-materiality" type="text" placeholder="minor / moderate / major" />
      </label>
      <label>Status
        <input id="f-status" type="text" placeholder="active / inactive" />
      </label>
      <label>Compensation Currency
        <input id="f-currency" type="text" placeholder="COMP / USDC / USD / ..." />
      </label>
      <label>Org Affiliation (for indirect)
        <input id="f-affil" type="text" placeholder="e.g., StableLab" />
      </label>
      <label>Start Date
        <input id="f-start" type="date" />
      </label>
      <label>Ongoing?
        <select id="f-ongoing">
          <option value="">unspecified</option>
          <option value="yes">yes</option>
          <option value="no">no</option>
        </select>
      </label>
      <label>Disclosure (short text)
        <input id="f-short" type="text" placeholder="e.g., Advisor to Project B; token-compensated." />
      </label>
      <label>Links (comma-separated)
        <input id="f-links" type="text" placeholder="https://..., https://..." />
      </label>
    </div>

    <button id="btn-disclose" style="padding:.6rem 1rem;cursor:pointer">Open GitHub Issue…</button>
    <small style="color:#666">Required fields marked with * · This form stores nothing; all data is submitted on GitHub.</small>
  </form>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

  <!-- Disclosure form logic -->
  <script>
    (function(){
      const repoNewIssueBase = 'https://github.com/emjicy/coi-registry/issues/new';
      const labelList = ['disclosure'];

      function mdEscape(s){ return (s||'').replace(/</g,'&lt;'); }

      function buildBody(fields){
        const linksArr = fields.links.split(',').map(s=>s.trim()).filter(Boolean);
        const walletsArr = fields.wallets.split(',').map(s=>s.trim()).filter(Boolean);
        return [
`### Disclosure Submission

**delegate_id:** ${mdEscape(fields.id)}
**display_name:** ${mdEscape(fields.name)}
**organization:** ${mdEscape(fields.org)}
**wallets:** ${walletsArr.map(w=> '`'+w+'`').join(', ') || ''}

**interest:**
- type: ${mdEscape(fields.type)}
- project: ${mdEscape(fields.project)}
- role: ${mdEscape(fields.role)}
- interest_type: ${mdEscape(fields.itype)}
- materiality: ${mdEscape(fields.materiality)}
- status: ${mdEscape(fields.status)}
- compensation_currency: ${mdEscape(fields.currency)}
- org_affiliation: ${mdEscape(fields.affil)}
- time:
  - start_date: ${mdEscape(fields.start)}
  - ongoing: ${mdEscape(fields.ongoing)}
- disclosure:
  - short_text: ${mdEscape(fields.short)}
  - links: ${linksArr.map(l=> `<${l}>`).join(', ') || ''}

> Submitted via coi.oxcart.vote`,
        ].join('\n');
      }

      function openIssue(){
        const f = {
          id: document.getElementById('f-id').value.trim(),
          name: document.getElementById('f-name').value.trim(),
          org: document.getElementById('f-org').value.trim(),
          wallets: document.getElementById('f-wallets').value.trim(),
          type: document.getElementById('f-type').value,
          project: document.getElementById('f-project').value.trim(),
          role: document.getElementById('f-role').value.trim(),
          itype: document.getElementById('f-itype').value.trim(),
          materiality: document.getElementById('f-materiality').value.trim(),
          status: document.getElementById('f-status').value.trim(),
          currency: document.getElementById('f-currency').value.trim(),
          affil: document.getElementById('f-affil').value.trim(),
          start: document.getElementById('f-start').value,
          ongoing: document.getElementById('f-ongoing').value,
          short: document.getElementById('f-short').value.trim(),
          links: document.getElementById('f-links').value.trim(),
        };

        // Mirror backend required fields
        const missing = [];
        if (!f.id) missing.push('Delegate ID / ENS');
        if (!f.type) missing.push('Type (direct/indirect)');
        if (!f.project) missing.push('Project');
        if (missing.length) {
          alert('Please complete required fields: ' + missing.join(', '));
          return;
        }

        const title = encodeURIComponent(`[Disclosure] ${f.id} → ${f.project}`);
        const body  = encodeURIComponent(buildBody(f));
        const labels = encodeURIComponent(labelList.join(','));
        const url = `${repoNewIssueBase}?title=${title}&body=${body}&labels=${labels}`;
        window.open(url, '_blank', 'noopener');
      }

      document.getElementById('btn-disclose').addEventListener('click', openIssue);
    })();
  </script>

  <!-- Registry table logic -->
  <script>
    const DATA_URL = 'registry.json';

    const PREFERRED_ORDER = [
      'type','delegate_id','delegate_name','organization','project','role',
      'interest_type','materiality','status','compensation_currency','org_affiliation',
      'start_date','ongoing','disclosure','links','wallets','forum_profile','twitter','website','last_updated'
    ];

    const fmtDate = (s) => {
      if (!s) return '';
      const d = new Date(s);
      return isNaN(d) ? s : d.toISOString().slice(0,10);
    };

    const shortAddr = (a) => /^0x[a-fA-F0-9]{40}$/.test(a) ? (a.slice(0,6) + '…' + a.slice(-4)) : a;
    const aTag = (href, text=href) => `<a href="${href}" target="_blank" rel="noopener">${text}</a>`;
    const linkify = (v) => (typeof v === 'string' && /^https?:\/\//i.test(v)) ? aTag(v) : v;

    const renderCell = (v) => {
      if (v == null) return '';
      if (Array.isArray(v)) return v.map(x => renderCell(x)).join('<br/>');
      if (typeof v === 'object') {
        if (v.short_text) return v.short_text;
        return Object.entries(v).map(([k,val]) => `<strong>${k}</strong>: ${renderCell(val)}`).join('<br/>');
      }
      return linkify(String(v));
    };

    function flatten(json){
      const out = [];
      const delegates = json?.delegates || [];
      const metaEl = document.getElementById('meta');
      if (metaEl) {
        const v = json?.version ? `v${json.version}` : '';
        const g = json?.generated_at ? ` • generated ${fmtDate(json.generated_at)}` : '';
        const m = json?.maintainer ? ` • maintainer: ${json.maintainer}` : '';
        metaEl.textContent = [v,g,m].filter(Boolean).join('');
      }

      for (const d of delegates) {
        const base = {
          delegate_id: d.id || '',
          delegate_name: d.display_name || '',
          organization: d.organization || '',
          wallets: (d.wallets || []).map(shortAddr).join('<br/>'),
          forum_profile: d.contacts?.forum_profile ? aTag(d.contacts.forum_profile, 'forum') : '',
          twitter: d.contacts?.twitter ? aTag(d.contacts.twitter, 'twitter') : '',
          website: d.contacts?.website ? aTag(d.contacts.website, 'website') : '',
          last_updated: fmtDate(d.last_updated),
        };

        const pushRows = (arr, type) => {
          (arr || []).forEach(item => {
            out.push({
              ...base,
              type,
              project: item.project || '',
              role: item.role || '',
              interest_type: item.interest_type || '',
              materiality: item.materiality || '',
              status: item.status || '',
              compensation_currency: item.compensation_currency || '',
              org_affiliation: item.org_affiliation || '',
              start_date: fmtDate(item.time?.start_date),
              ongoing: (item.time?.ongoing === true) ? 'yes' : (item.time?.ongoing === false ? 'no' : ''),
              disclosure: item.disclosure?.short_text || '',
              links: [
                ...(item.disclosure?.links || []),
                ...(item.links || [])
              ].map(h => aTag(h)).join('<br/>')
            });
          });
        };

        pushRows(d.interests?.direct, 'direct');
        pushRows(d.interests?.indirect, 'indirect');
      }
      return out;
    }

    fetch(DATA_URL)
      .then(r => r.json())
      .then(json => {
        const rows = flatten(json);
        if (!rows.length) throw new Error('No entries found in registry.json (no interests to display).');

        const presentKeys = Array.from(rows.reduce((s,row)=>{Object.keys(row).forEach(k=>s.add(k)); return s;}, new Set()));
        const columns = [
          ...PREFERRED_ORDER.filter(k => presentKeys.includes(k)),
          ...presentKeys.filter(k => !PREFERRED_ORDER.includes(k))
        ];
        const data = rows.map(r => columns.map(k => renderCell(r[k])));

        $('#registry').DataTable({
          data,
          columns: columns.map(k => ({ title: k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()) })),
          pageLength: 25,
          order: [[0, 'asc']],
          deferRender: true
        });
      })
      .catch(err => {
        document.body.insertAdjacentHTML('beforeend',
          `<p style="color:#c00">Error loading registry.json: ${err.message}</p>
           <p><a href="${DATA_URL}" target="_blank" rel="noopener">Open registry.json</a></p>`);
      });
  </script>
</body>
</html>
