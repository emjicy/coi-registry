<script>
  // replace your existing buildBody() with this:
  function buildBody(fields){
    const linksArr   = fields.links.split(',').map(s=>s.trim()).filter(Boolean);
    const walletsArr = fields.wallets.split(',').map(s=>s.trim()).filter(Boolean);

    // Canonical payload that matches registry.json shape
    const payload = {
      delegate_id: fields.id,
      display_name: fields.name || fields.id,
      organization: fields.org || "",
      wallets: walletsArr,
      interest: {
        type: (fields.type || "").toLowerCase(),
        project: fields.project,
        role: fields.role || "",
        interest_type: fields.itype || "",
        materiality: fields.materiality || "",
        status: fields.status || "",
        compensation_currency: fields.currency || "",
        org_affiliation: fields.affil || "",
        time: {
          start_date: fields.start || "",
          ongoing: fields.ongoing ? (fields.ongoing.toLowerCase() === 'yes') : undefined
        },
        disclosure: {
          short_text: fields.short || "",
          links: linksArr
        },
        links: linksArr
      }
    };

    const md = [
`### Disclosure Submission

**delegate_id:** ${fields.id}
**display_name:** ${fields.name || ""}
**organization:** ${fields.org || ""}
**wallets:** ${walletsArr.map(w=> '`'+w+'`').join(', ') || ''}

**interest:**
- type: ${fields.type}
- project: ${fields.project}
- role: ${fields.role || ""}
- interest_type: ${fields.itype || ""}
- materiality: ${fields.materiality || ""}
- status: ${fields.status || ""}
- compensation_currency: ${fields.currency || ""}
- org_affiliation: ${fields.affil || ""}
- time:
  - start_date: ${fields.start || ""}
  - ongoing: ${fields.ongoing || ""}
- disclosure:
  - short_text: ${fields.short || ""}
  - links: ${linksArr.map(l=> `<${l}>`).join(', ') || ''}

<!-- COI_JSON_START -->
\`\`\`json
${JSON.stringify(payload, null, 2)}
\`\`\`
<!-- COI_JSON_END -->

> Submitted via coi.oxcart.vote`
    ].join('\n');

    return md;
  }
</script>

