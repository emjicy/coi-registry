<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>COI Registry</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; margin: 2rem; }
    h1 { margin: 0 0 .25rem 0 }
    .sub { color: #666; margin: 0 0 .75rem 0 }
    .meta { color:#666; font-size:.9rem; margin: 0 0 1.25rem 0 }
    table { width: 100% }
    a { text-decoration: none }
    a:hover { text-decoration: underline }
  </style>
</head>
<hr style="margin:2rem 0"/>

<h2>Submit a Disclosure</h2>
<p class="sub">Use this form to pre-fill a GitHub Issue in the <a href="https://github.com/emjicy/coi-registry" target="_blank" rel="noopener">coi-registry</a> repository. You’ll review and submit it there.</p>

<form id="disclosure-form" onsubmit="return false;" style="max-width:720px">
  <div style="display:grid;gap:.75rem">
    <label>Delegate ID / ENS
      <input id="f-id" type="text" required placeholder="e.g., mel.eth" style="width:100%;padding:.5rem"/>
    </label>
    <label>Display Name
      <input id="f-name" type="text" placeholder="e.g., mel.eth (StableLab)" style="width:100%;padding:.5rem"/>
    </label>
    <label>Organization
      <input id="f-org" type="text" placeholder="e.g., StableLab" style="width:100%;padding:.5rem"/>
    </label>
    <label>Wallet(s) (comma-separated)
      <input id="f-wallets" type="text" placeholder="0x..., 0x..." style="width:100%;padding:.5rem"/>
    </label>

    <div style="display:grid;gap:.5rem;padding:.75rem;border:1px solid #ddd;border-radius:.5rem">
      <strong>Interest Details</strong>
      <label>Type
        <select id="f-type" style="width:100%;padding:.5rem">
          <option value="direct">direct</option>
          <option value="indirect">indirect</option>
        </select>
      </label>
      <label>Project
        <input id="f-project" type="text" required placeholder="e.g., Protocol X" style="width:100%;padding:.5rem"/>
      </label>
      <label>Role
        <input id="f-role" type="text" placeholder="advisor / investor / service_provider" style="width:100%;padding:.5rem"/>
      </label>
      <label>Interest Type
        <input id="f-itype" type="text" placeholder="tokens / equity / retainer / grants" style="width:100%;padding:.5rem"/>
      </label>
      <label>Materiality
        <input id="f-materiality" type="text" placeholder="minor / moderate / major" style="width:100%;padding:.5rem"/>
      </label>
      <label>Status
        <input id="f-status" type="text" placeholder="active / inactive" style="width:100%;padding:.5rem"/>
      </label>
      <label>Compensation Currency
        <input id="f-currency" type="text" placeholder="COMP / USDC / USD / ..." style="width:100%;padding:.5rem"/>
      </label>
      <label>Org Affiliation (for indirect)
        <input id="f-affil" type="text" placeholder="e.g., StableLab" style="width:100%;padding:.5rem"/>
      </label>
      <label>Start Date
        <input id="f-start" type="date" style="width:100%;padding:.5rem"/>
      </label>
      <label>Ongoing?
        <select id="f-ongoing" style="width:100%;padding:.5rem">
          <option value="">unspecified</option>
          <option value="yes">yes</option>
          <option value="no">no</option>
        </select>
      </label>
      <label>Disclosure (short text)
        <input id="f-short" type="text" placeholder="e.g., Advisor to Project B; token-compensated." style="width:100%;padding:.5rem"/>
      </label>
      <label>Links (comma-separated)
        <input id="f-links" type="text" placeholder="https://..., https://..." style="width:100%;padding:.5rem"/>
      </label>
    </div>

    <button id="btn-disclose" style="padding:.6rem 1rem;cursor:pointer">Open GitHub Issue…</button>
    <small style="color:#666">Note: You will review and submit on GitHub. This form never stores your data.</small>
  </div>
</form>

<script>
(function(){
  const repoNewIssueBase = 'https://github.com/emjicy/coi-registry/issues/new';
  const labelList = ['disclosure']; // add more default labels if desired

  function mdEscape(s){ return (s||'').replace(/</g,'&lt;'); }

  function buildBody(fields){
    // Compose a Markdown block that maintainers can parse or a script can transform into JSON/PR.
    const linksArr = fields.links.split(',').map(s=>s.trim()).filter(Boolean);
    const walletsArr = fields.wallets.split(',').map(s=>s.trim()).filter(Boolean);

    return [
`### Disclosure Submission

**delegate_id:** ${mdEscape(fields.id)}
**display_name:** ${mdEscape(fields.name)}
**organization:** ${mdEscape(fields.org)}
**wallets:** ${walletsArr.map(w=> '`'+w+'`').join(', ') || ''}

**interest:**
- type: ${mdEscape(fields.type)}
- project: ${mdEscape(fields.project)}
- role: ${mdEscape(fields.role)}
- interest_type: ${mdEscape(fields.itype)}
- materiality: ${mdEscape(fields.materiality)}
- status: ${mdEscape(fields.status)}
- compensation_currency: ${mdEscape(fields.currency)}
- org_affiliation: ${mdEscape(fields.affil)}
- time:
  - start_date: ${mdEscape(fields.start)}
  - ongoing: ${mdEscape(fields.ongoing)}
- disclosure:
  - short_text: ${mdEscape(fields.short)}
  - links: ${linksArr.map(l=> `<${l}>`).join(', ') || ''}

> Submitted via coi.oxcart.vote`,
    ].join('\n');
  }

  function openIssue(){
    const f = {
      id: document.getElementById('f-id').value.trim(),
      name: document.getElementById('f-name').value.trim(),
      org: document.getElementById('f-org').value.trim(),
      wallets: document.getElementById('f-wallets').value.trim(),
      type: document.getElementById('f-type').value,
      project: document.getElementById('f-project').value.trim(),
      role: document.getElementById('f-role').value.trim(),
      itype: document.getElementById('f-itype').value.trim(),
      materiality: document.getElementById('f-materiality').value.trim(),
      status: document.getElementById('f-status').value.trim(),
      currency: document.getElementById('f-currency').value.trim(),
      affil: document.getElementById('f-affil').value.trim(),
      start: document.getElementById('f-start').value,
      ongoing: document.getElementById('f-ongoing').value,
      short: document.getElementById('f-short').value.trim(),
      links: document.getElementById('f-links').value.trim(),
    };

    if (!f.id || !f.project) {
      alert('Please provide at least "Delegate ID" and "Project".');
      return;
    }

    const title = encodeURIComponent(`[Disclosure] ${f.id} → ${f.project}`);
    const body = encodeURIComponent(buildBody(f));
    const labels = encodeURIComponent(labelList.join(','));
    const url = `${repoNewIssueBase}?title=${title}&body=${body}&labels=${labels}`;
    window.open(url, '_blank', 'noopener');
  }

  document.getElementById('btn-disclose').addEventListener('click', openIssue);
})();
</script>
  
<body>
  <h1>Conflict of Interest Registry</h1>
  <p class="sub">Transparent, auditable disclosures for DAO governance.</p>
  <p class="meta" id="meta"></p>

  <table id="registry" class="display compact"></table>

  <p style="margin-top:1rem">
    <a href="registry.json" download>Download JSON</a> ·
    <a href="https://github.com/emjicy/coi-registry">Contribute on GitHub</a>
  </p>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script>
    // ---- configuration ----
    const DATA_URL = 'registry.json';

    // Column order for flattened rows
    const PREFERRED_ORDER = [
      'type',                 // direct | indirect
      'delegate_id',
      'delegate_name',
      'organization',
      'project',
      'role',
      'interest_type',
      'materiality',
      'status',
      'compensation_currency',
      'org_affiliation',
      'start_date',
      'ongoing',
      'disclosure',
      'links',
      'wallets',
      'forum_profile',
      'twitter',
      'website',
      'last_updated'
    ];

    // ---- helpers ----
    const fmtDate = (s) => {
      if (!s) return '';
      const d = new Date(s);
      return isNaN(d) ? s : d.toISOString().slice(0,10);
    };

    const shortAddr = (a) =>
      /^0x[a-fA-F0-9]{40}$/.test(a) ? (a.slice(0,6) + '…' + a.slice(-4)) : a;

    const aTag = (href, text=href) =>
      `<a href="${href}" target="_blank" rel="noopener">${text}</a>`;

    const linkify = (v) => (typeof v === 'string' && /^https?:\/\//i.test(v)) ? aTag(v) : v;

    const renderCell = (v) => {
      if (v == null) return '';
      if (Array.isArray(v)) return v.map(x => renderCell(x)).join('<br/>');
      if (typeof v === 'object') {
        if (v.short_text) return v.short_text; // disclosure object
        return Object.entries(v).map(([k,val]) => `<strong>${k}</strong>: ${renderCell(val)}`).join('<br/>');
      }
      return linkify(String(v));
    };

    // Flatten { delegates: [ { interests: { direct[], indirect[] } } ] } → rows
    function flatten(json){
      const out = [];
      const delegates = json?.delegates || [];
      // header meta (optional)
      const metaEl = document.getElementById('meta');
      if (metaEl) {
        const v = json?.version ? `v${json.version}` : '';
        const g = json?.generated_at ? ` • generated ${fmtDate(json.generated_at)}` : '';
        const m = json?.maintainer ? ` • maintainer: ${json.maintainer}` : '';
        metaEl.textContent = [v,g,m].filter(Boolean).join('');
      }

      for (const d of delegates) {
        const base = {
          delegate_id: d.id || '',
          delegate_name: d.display_name || '',
          organization: d.organization || '',
          wallets: (d.wallets || []).map(shortAddr).join('<br/>'),
          forum_profile: d.contacts?.forum_profile ? aTag(d.contacts.forum_profile, 'forum') : '',
          twitter: d.contacts?.twitter ? aTag(d.contacts.twitter, 'twitter') : '',
          website: d.contacts?.website ? aTag(d.contacts.website, 'website') : '',
          last_updated: fmtDate(d.last_updated),
        };

        const pushRows = (arr, type) => {
          (arr || []).forEach(item => {
            out.push({
              ...base,
              type,
              project: item.project || '',
              role: item.role || '',
              interest_type: item.interest_type || '',
              materiality: item.materiality || '',
              status: item.status || '',
              compensation_currency: item.compensation_currency || '',
              org_affiliation: item.org_affiliation || '',
              start_date: fmtDate(item.time?.start_date),
              ongoing: (item.time?.ongoing === true) ? 'yes' : (item.time?.ongoing === false ? 'no' : ''),
              disclosure: item.disclosure?.short_text || '',
              links: [
                ...(item.disclosure?.links || []),
                ...(item.links || [])
              ].map(h => aTag(h)).join('<br/>')
            });
          });
        };

        pushRows(d.interests?.direct, 'direct');
        pushRows(d.interests?.indirect, 'indirect');
      }
      return out;
    }

    // ---- bootstrap table ----
    fetch(DATA_URL)
      .then(r => r.json())
      .then(json => {
        const rows = flatten(json);
        if (!rows.length) throw new Error('No entries found in registry.json (no interests to display).');

        const presentKeys = Array.from(rows.reduce((s,row)=>{Object.keys(row).forEach(k=>s.add(k)); return s;}, new Set()));
        const columns = [
          ...PREFERRED_ORDER.filter(k => presentKeys.includes(k)),
          ...presentKeys.filter(k => !PREFERRED_ORDER.includes(k))
        ];
        const data = rows.map(r => columns.map(k => renderCell(r[k])));

        $('#registry').DataTable({
          data,
          columns: columns.map(k => ({ title: k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()) })),
          pageLength: 25,
          order: [[0, 'asc']],
          deferRender: true
        });
      })
      .catch(err => {
        document.body.insertAdjacentHTML('beforeend',
          `<p style="color:#c00">Error loading registry.json: ${err.message}</p>
           <p><a href="${DATA_URL}" target="_blank" rel="noopener">Open registry.json</a></p>`);
      });
  </script>
</body>
</html>
